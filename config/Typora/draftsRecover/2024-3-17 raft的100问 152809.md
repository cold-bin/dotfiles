## raft 100 问

### 1，Raft 协议什么作用

- 保证分布式各节点状态的强一致性。raft通过leader来强制follower的日志与leader一样新，所以正常情况下集群多数节点都和leader保持一致
- 提高分布式系统的可用性。不论是leader还是follower宕机，只要集群有超过半数节点之间网络不分区并正常工作，那么整个以raft协议为底层的分布式系统都可以继续工作，具有很好的容错性

## 2，详细介绍 Raft 流程

1. 启动。所有节点刚开始的时候都是follower，并开启一个随机选举计时器，当选举计时器超时还没受到leader的心跳时，会转化为candidate选举。由于随即定时器的作用，candidate一般不会同时发起投票选举。所以一般不会经过几轮选举就能够选举出leader,然后leader广播心跳维护自己的统治地位。其他candidate或者follower收到心跳就会转变为follower并重置选举定时器
2. 投票。每个新加入的candidate会先给自己投一票并将任期+1，然后请求follower给自己投票，当收到的当前任期投票数超过一半时，就会成为leader，并立即广播心跳维护权威。
3. 日志复制。客户端只会请求leader,leader将所需要执行的操作记录到底层raft里，然后再向follower发送日志同步rpc,等到集群有超过半数的节点成功接收日志，leader可以提交和应用日志了。在leader的下一次心跳会告知follower leader的提交，这时follower也可以提交和应用日志了
4. 持久化。节点会将自己的某些状态持久化到磁盘里来避免重新启动时状态丢失的问题
5. 快照。当节点日志过多，防止内存占用过大，需要进行快照。集群每个节点都有快照权力。而且当集群中某个follower日志太过落后或者新加入的follower，可以直接发送快照来使follower尽快地跟上leader
6. 一些安全性规则。例如，投票时只能投给日志更新或一样新的，日志复制的时候，还需要做一致性检查等。

## 3，follower 会响应 client 的读写操作吗

会

- 写请求会改变状态机需要提交到raft里。如果有半数及以上的follower宕机或者与leader网络分区，那么leader的日志就无法提交，也就无法应用，这个时候客户端的写操作就会超时重试。
- 读请求一般不会影响状态机。在一些raft实现里，会将客户端的读请求定向到follower里。例如可以在响应读请求前，先向follower发送心跳保证一致性，接收到这次心跳的follower才能给client提供读请求服务。这样可以保证线性一致性。这种情况下，follower是会对读操作影响的。（有可能心跳过后突然网络分区挂了，然后客户端的请求阻塞一段时间才到，那么请求到的结果在顺序一致性可能存在问题。）当然，在另外一些实现里，性能较差，比如读请求也需要进入状态机。这种情况和写操作一样。

## 4，超过半数的决策机制如何保证 leader 日志的完整性

在选举时，只有较新日志的candidate才能获取选票，获取超过半数选票才能当选leader，然而集群中超过半数节点的日志应该是一样的最新的，所以，leader只能从这些日志最新的节点选举出来。这就保证了重新选举出来的leader日志依然是完整的包含所有已经提交的日志项。